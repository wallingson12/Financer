{% extends "base.html" %}
{% block content %}
<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
        <h2>Transações</h2>
        <a href="/"><button type="button">← Dashboard</button></a>
    </div>

    <!-- FILTRO DE MÊS -->
    <div class="filtro" style="margin-bottom:1.5rem;">
        <label>Filtrar por mês:</label>
        <select id="filtroMes" onchange="filtrarMes()">
            <option value="todos">Todos</option>
            {% set meses_vistos = [] %}
            {% for r in registros %}
                {% set mes = r['data'][:7] %}
                {% if mes not in meses_vistos %}
                    {% set _ = meses_vistos.append(mes) %}
                    <option value="{{ mes }}">{{ mes }}</option>
                {% endif %}
            {% endfor %}
        </select>
    </div>

    <table class="tabela">
        <thead>
            <tr>
                <th>Data</th>
                <th>Tipo</th>
                <th>Detalhe</th>
                <th>Crédito</th>
                <th>Débito</th>
                <th>Categoria</th>
            </tr>
        </thead>
        <tbody id="corpoTabela">
            {% for r in registros %}
            <tr data-mes="{{ r['data'][:7] }}">
                <td>{{ r['data'] }}</td>
                <td>{{ r['tipo'] }}</td>
                <td>{{ r['detalhe'] }}</td>
                <td class="valor-credito">R$ {{ "%.2f"|format(r['credito']) }}</td>
                <td class="valor-debito">R$ {{ "%.2f"|format(r['debito']) }}</td>
                <td>
                    <form action="/categorizar" method="POST" class="form-categoria">
                        <input type="hidden" name="transacao_id" value="{{ r['id'] }}">

                        <select name="categoria" onchange="mostrarOpcoes(this)">
                            {% for cat in categorias %}
                                <option value="{{ cat }}" {% if cat == r['categoria'] %}selected{% endif %}>
                                    {{ cat }}
                                </option>
                            {% endfor %}
                        </select>

                        <div class="opcoes-categoria" style="display:none; margin-top:0.5rem;">
                            <label style="font-size:0.85rem;">
                                <input type="checkbox" name="aplicar_todas" value="1">
                                Aplicar em todas iguais
                            </label>
                            <button type="submit" class="btn-pequeno">Salvar</button>
                        </div>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function filtrarMes() {
    const mes = document.getElementById('filtroMes').value;
    document.querySelectorAll('#corpoTabela tr').forEach(tr => {
        tr.style.display = (mes === 'todos' || tr.dataset.mes === mes) ? '' : 'none';
    });
}

function mostrarOpcoes(select) {
    const form = select.closest('.form-categoria');
    const opcoes = form.querySelector('.opcoes-categoria');

    if (!select.dataset.original) {
        select.dataset.original = select.value;
    }

    opcoes.style.display = select.value !== select.dataset.original ? 'block' : 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.form-categoria select').forEach(select => {
        select.dataset.original = select.value;
    });
});
</script>

<style>
.form-categoria {
    display: flex;
    flex-direction: column;
}

.opcoes-categoria {
    padding: 0.5rem;
    background: #f9f9f9;
    border-radius: 4px;
    border: 1px solid #ddd;
}

.opcoes-categoria label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
    font-weight: normal;
}

.btn-pequeno {
    padding: 0.3rem 0.8rem;
    font-size: 0.85rem;
    margin-top: 0.3rem;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.btn-pequeno:hover {
    background: #0056b3;
}
</style>

{% endblock %}